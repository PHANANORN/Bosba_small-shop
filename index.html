<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Shop - V67 Fixed History & Nav</title>
    <meta name="theme-color" content="#0F766E">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081559.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Battambang', 'sans-serif'],
                        serif: ['Noto Serif Khmer', 'serif'],
                    },
                    colors: {
                        light: { bg: '#F8FAFC', card: '#ffffff' }, 
                        dark: { bg: '#020617', card: '#1e293b' }   
                    },
                    boxShadow: {
                        'pop': '0 4px 20px -2px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0,0,0,0.05)',
                        'glow': '0 0 15px rgba(13, 148, 136, 0.4)',
                        'float': '0 20px 40px -5px rgba(0,0,0,0.2), 0 10px 20px -5px rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Noto+Serif+Khmer:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* BASE & SCROLL */
        body { font-family: 'Battambang', sans-serif; background-color: #F8FAFC; color: #334155; -webkit-tap-highlight-color: transparent; padding-bottom: 110px; overscroll-behavior-y: none; }
        .dark body { background-color: #020617; color: #f8fafc; } 
        .font-serif-kh { font-family: 'Noto Serif Khmer', serif; }
        
        /* === SMART HEADER ANIMATION (SMOOTH SCROLL) === */
        /* Applied to both Home and Report headers */
        .smart-header-anim {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            z-index: 40; 
            /* Improved Transition: Soft landing easing */
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.3s ease;
        }
        .hide-ui { transform: translateY(-120%); opacity: 0; pointer-events: none; }

        /* === HOME HEADER STYLES === */
        .header-bg { 
            background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%); 
            padding-top: max(10px, env(safe-area-inset-top)); 
            padding-bottom: 80px; /* Space for stats */
            border-bottom-left-radius: 35px; 
            border-bottom-right-radius: 35px; 
            box-shadow: 0 15px 35px -5px rgba(15, 118, 110, 0.5); 
            position: relative;
            overflow: visible; /* Important for stats to float out */
        }
        /* Texture for Home */
        .header-bg::before {
            content: ''; position: absolute; inset: 0; opacity: 0.1; pointer-events: none;
            background-image: radial-gradient(rgba(255,255,255,0.8) 1px, transparent 1px);
            background-size: 15px 15px; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px;
        }
        .dark .header-bg { background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%); }

        /* FLOATING STATS (Attached to Header) */
        .floating-stats-container { 
            position: absolute; 
            bottom: -45px; /* Half in, half out */
            left: 0; 
            width: 100%; 
            padding: 0 20px; 
            z-index: 50; 
            display: flex; 
            justify-content: center; 
        }
        .stat-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(15px);
            border-radius: 24px; 
            padding: 16px; 
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255,255,255,0.5); 
            border: 1px solid rgba(255,255,255,0.8); 
        }
        .dark .stat-card { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* === REPORT HEADER STYLES (NEW TEXTURE ADDED) === */
        #report-header-container { display: none; } /* Hidden by default until tab active */
        
        .report-header-bg {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            padding-top: max(10px, env(safe-area-inset-top));
            padding-bottom: 20px;
            padding-left: 16px; padding-right: 16px;
            border-bottom: 1px solid rgba(13, 148, 136, 0.15);
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            /* Enhanced Shadow */
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.12); 
            position: relative;
            z-index: 40;
        }
        /* NEW: Texture for Report Header (Requested Point 1) */
        .report-header-bg::after {
            content: ''; position: absolute; inset: 0; opacity: 0.08; pointer-events: none; z-index: -1;
            /* Dot Pattern */
            background-image: radial-gradient(#0f766e 1.5px, transparent 1.5px); 
            background-size: 16px 16px;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
        }
        .dark .report-header-bg { background: rgba(15, 23, 42, 0.98); }
        .dark .report-header-bg::after { background-image: radial-gradient(#ffffff 1px, transparent 1px); opacity: 0.05; }

        /* MAIN LAYOUT SPACING */
        .main-content { padding: 0 16px; position: relative; z-index: 10; transition: margin-top 0.3s ease; } 
        /* Home starts with margin because header is tall */
        #view-home { margin-top: 260px; }
        /* Reports starts with margin because header is shorter but fixed */
        #view-reports { margin-top: 190px; }

        .search-box-container { position: sticky; top: 10px; z-index: 30; margin-bottom: 20px; }

        /* NAVIGATION */
        .nav-container { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 85px; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.05); 
            display: grid; grid-template-columns: 1fr 1fr 70px 1fr 1fr; align-items: center; 
            padding-bottom: env(safe-area-inset-bottom); z-index: 50; 
            border-top-left-radius: 30px; border-top-right-radius: 30px; 
            border-top: 1px solid rgba(255,255,255,0.5);
        }
        .dark .nav-container { background: rgba(15, 23, 42, 0.9); border-top: 1px solid rgba(255,255,255,0.1); box-shadow: 0 -10px 40px rgba(0,0,0,0.3); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 11px; cursor: pointer; height: 100%; transition: all 0.2s; }
        .nav-item.active { color: #0f766e; font-weight: 700; transform: translateY(-2px); }
        .dark .nav-item.active { color: #2dd4bf; }
        
        .fab-wrapper { position: relative; top: -35px; width: 65px; height: 65px; display: flex; justify-content: center; align-items: center; z-index: 60; }
        .fab-button { 
            width: 60px; height: 60px; 
            background: linear-gradient(135deg, #0d9488, #0f766e); 
            border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-size: 26px; 
            box-shadow: 0 10px 25px rgba(13, 148, 136, 0.4); 
            cursor: pointer; transition: transform 0.2s; 
            border: 4px solid #F1F5F9; 
        }
        .dark .fab-button { border-color: #020617; box-shadow: 0 0 20px rgba(45, 212, 191, 0.4); }
        .fab-button:active { transform: scale(0.95); }

        /* CARD DESIGN */
        .order-card { 
            background: #ffffff;
            border-radius: 20px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px; 
            position: relative; 
            cursor: pointer; 
            overflow: hidden;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .order-card:active { transform: scale(0.98); }
        .dark .order-card { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }

        .card-strip { position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
        .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; display: inline-flex; items-center; gap: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        .input-field { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 16px; outline: none; font-size: 16px; background: #fff; transition: all 0.2s; }
        .input-field:focus { border-color: #0d9488; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
        .dark .input-field { background: #334155; border-color: #475569; color: white; }
        .dark .input-field:focus { border-color: #2dd4bf; }
        
        .section-view { display: none; } .section-view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150px); background: #064E3B; color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; font-weight: bold; z-index: 999999; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); border: 2px solid #34D399; }
        .toast.show { transform: translateX(-50%) translateY(0); }

        #modal-confirm-overlay, #modal-import-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 99999; backdrop-filter: blur(4px); }
        .confirm-box { background: white; width: 85%; max-width: 320px; padding: 25px; border-radius: 24px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #modal-trash { z-index: 100; }
        #invoice-viewer { font-feature-settings: "liga" 0; font-variant-ligatures: none; letter-spacing: normal !important; }
        #modal-note { z-index: 99999; }
        .glass-box { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 25px 50px -10px rgba(0,0,0,0.15); }
        .dark .glass-box { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255,255,255,0.1); }
        #app-loader { position: fixed; inset: 0; z-index: 9999999; display: none; justify-content: center; align-items: center; background: rgba(255,255,255,0.8); transition: opacity 0.5s; backdrop-filter: blur(8px); }
        .dark #app-loader { background: rgba(15, 23, 42, 0.8); }

        /* === MODERN REPORT & DATE UI === */
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .report-item { background: #ffffff; border-radius: 16px; padding: 14px; border: 1px solid #f1f5f9; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .dark .report-item { background: #334155; border-color: #475569; }
        
        .date-btn-active { 
            background: linear-gradient(135deg, #0d9488, #0f766e) !important; 
            color: white !important; 
            border: none !important;
            box-shadow: 0 4px 10px rgba(13, 148, 136, 0.3);
        }
        
        .card-gradient-green { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1px solid #a7f3d0; }
        .dark .card-gradient-green { background: linear-gradient(135deg, #064e3b 0%, #065f46 100%); border: 1px solid #059669; }

        /* MODERN FLATPICKR INPUT STYLES */
        .modern-date-input {
            width: 100%;
            background: #ffffff;
            border-radius: 14px;
            padding: 10px 14px 10px 42px; /* Left padding for icon */
            font-size: 13px;
            font-weight: 700;
            color: #334155;
            border: 1px solid #e2e8f0;
            outline: none;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .dark .modern-date-input { background: #334155; border-color: #475569; color: white; }
        .modern-date-input:focus { border-color: #0d9488; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
        
        .date-icon-overlay {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: #94a3b8; pointer-events: none; z-index: 10;
        }
        .dark .date-icon-overlay { color: #64748b; }
        .group:focus-within .date-icon-overlay { color: #0d9488; }

        /* === FLATPICKR CUSTOM THEME FIXES === */
        .flatpickr-calendar { border-radius: 16px !important; box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important; border: none !important; font-family: 'Battambang', sans-serif !important; overflow: hidden !important; }
        .dark .flatpickr-calendar { background: #1e293b !important; box-shadow: 0 10px 40px rgba(0,0,0,0.6) !important; }
        .flatpickr-months { background: #0F766E !important; border-top-left-radius: 16px !important; border-top-right-radius: 16px !important; padding: 10px 0 !important; }
        .flatpickr-months .flatpickr-month { background: transparent !important; color: #fff !important; fill: #fff !important; height: 40px !important; }
        .flatpickr-current-month .flatpickr-monthDropdown-months { background-color: transparent !important; color: #ffffff !important; font-weight: 900 !important; font-size: 16px !important; appearance: none; -webkit-appearance: none; cursor: pointer; }
        .flatpickr-current-month .flatpickr-monthDropdown-months:hover { background-color: rgba(255,255,255,0.1) !important; }
        .flatpickr-monthDropdown-months option { color: #000 !important; background-color: #fff !important; }
        .flatpickr-current-month input.cur-year { color: #ffffff !important; font-weight: 900 !important; font-size: 16px !important; }
        .flatpickr-current-month .numInputWrapper span.arrowUp:after { border-bottom-color: #ffffff !important; }
        .flatpickr-current-month .numInputWrapper span.arrowDown:after { border-top-color: #ffffff !important; }
        .flatpickr-current-month .numInputWrapper:hover { background: rgba(255,255,255,0.1) !important; }
        .flatpickr-weekdays { background: #0F766E !important; padding-bottom: 5px !important; }
        .flatpickr-weekday { color: rgba(255,255,255,0.8) !important; font-weight: bold !important; }
        .flatpickr-day { border-radius: 8px !important; font-weight: 500 !important; color: #334155 !important; }
        .dark .flatpickr-day { color: #cbd5e1 !important; }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay { background: #0F766E !important; border-color: #0F766E !important; color: white !important; box-shadow: 0 4px 10px rgba(15, 118, 110, 0.3) !important; }
        .flatpickr-day.today { border-color: #0F766E !important; }
        .flatpickr-day.today:hover { background: #0F766E !important; color: white !important; }

        /* === PDF STATEMENT PRINT STYLES (A4 STANDARD) === */
        @media print {
            @page { size: A4; margin: 1.5cm; }
            body { background: white !important; margin: 0 !important; padding: 0 !important; height: auto !important; overflow: visible !important; color: black !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body > *:not(#print-area) { display: none !important; }
            #print-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; z-index: 9999; }
            #print-area * { visibility: visible !important; }
            
            /* Table Styling for Print */
            table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; }
            th { background-color: #f3f4f6 !important; color: #374151 !important; font-weight: bold; text-transform: uppercase; padding: 10px; border-bottom: 2px solid #e5e7eb; border-top: 1px solid #e5e7eb; }
            td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
            tr { break-inside: avoid; page-break-inside: avoid; }
            
            /* Summary Cards in Print */
            .print-summary-box { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #fff; text-align: center; }
        }
    </style>
</head>
<body>
    
    <div id="app-loader">
        <div class="text-center">
            <div class="relative w-16 h-16 mx-auto mb-4">
                <div class="absolute inset-0 border-4 border-gray-200 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-teal-600 rounded-full border-t-transparent animate-spin"></div>
            </div>
            <p id="loader-text" class="text-teal-700 dark:text-teal-400 font-bold text-lg animate-pulse">កំពុងដំណើរការ...</p>
        </div>
    </div>

    <div id="toast" class="toast"><i class="fas fa-check-circle text-yellow-300 text-lg"></i><span id="toast-msg">រក្សាទុកជោគជ័យ!</span></div>

    <div id="print-area" class="hidden font-sans text-gray-800">
        <div class="flex justify-between items-start border-b-2 border-teal-600 pb-6 mb-6">
            <div>
                <h1 class="text-3xl font-bold text-teal-700 uppercase tracking-widest mb-1">Statement</h1>
                <p class="text-sm font-serif-kh text-gray-500">របាយការណ៍អាជីវកម្ម</p>
                <div class="mt-4 text-xs text-gray-500 leading-relaxed">
                    <strong>MY SMALL SHOP</strong><br>
                    Phnom Penh, Cambodia<br>
                    System Generated Report
                </div>
            </div>
            <div class="text-right">
                <div class="bg-gray-100 px-4 py-2 rounded mb-2">
                    <p class="text-xs text-gray-500 uppercase">Period / កាលបរិច្ឆេទ</p>
                    <p class="text-sm font-bold text-gray-800" id="print-date-range">...</p>
                </div>
                <p class="text-xs text-gray-400 mt-1">Printed: <span id="print-gen-date"></span></p>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="print-summary-box">
                <div class="text-xs text-gray-500 uppercase mb-1">Total Sales (ចំណូលសរុប)</div>
                <div class="text-xl font-bold text-teal-700" id="print-total-sales">$0.00</div>
            </div>
            <div class="print-summary-box">
                <div class="text-xs text-gray-500 uppercase mb-1">Total Expenses (ចំណាយសរុប)</div>
                <div class="text-xl font-bold text-red-500" id="print-total-exp">$0.00</div>
            </div>
            <div class="print-summary-box" style="background-color: #f0fdf4; border-color: #bbf7d0;">
                <div class="text-xs text-teal-600 uppercase mb-1">Net Profit (ចំណេញសុទ្ធ)</div>
                <div class="text-xl font-bold text-teal-800" id="print-net-profit">$0.00</div>
            </div>
        </div>

        <table class="w-full">
            <thead>
                <tr>
                    <th class="text-left w-24">Date</th>
                    <th class="text-left">Customer</th>
                    <th class="text-left">Product</th>
                    <th class="text-center w-12">Qty</th>
                    <th class="text-right w-20">Cost</th>
                    <th class="text-right w-20">Sale</th>
                    <th class="text-right w-20">Profit</th>
                </tr>
            </thead>
            <tbody id="print-table-body">
                </tbody>
        </table>

        <div class="mt-8 pt-8 border-t border-gray-200 text-center text-xs text-gray-400">
            <p>End of Statement</p>
            <p class="mt-1 opacity-70">Professional Report generated by My Small Shop Tracker</p>
        </div>
    </div>

    <div id="modal-note" class="hidden fixed inset-0 flex items-center justify-center bg-black/20 backdrop-blur-sm p-6 animate-fade-in">
        <div class="glass-box w-full max-w-xs rounded-3xl p-6 relative transform transition-all scale-100 shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-200 dark:border-gray-600 pb-3">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white font-serif-kh flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center"><i class="fas fa-sticky-note text-sm"></i></div>
                    ការកត់ចំណាំ
                </h3>
                <button onclick="document.getElementById('modal-note').classList.add('hidden')" class="w-8 h-8 rounded-full bg-gray-50 dark:bg-gray-700 flex items-center justify-center text-gray-500 dark:text-gray-300 hover:bg-red-50 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed font-sans bg-transparent min-h-[50px]">
                <p id="note-content-display"></p>
            </div>
        </div>
    </div>

    <div id="modal-confirm-overlay" class="hidden flex items-center justify-center">
        <div class="confirm-box dark:bg-gray-800">
            <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-trash-alt text-xl"></i></div>
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2 font-serif-kh">លុបការលក់នេះ?</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">ទិន្ន័យនឹងត្រូវបានផ្លាស់ទីទៅធុងសំរាម.</p>
            <div class="flex gap-3"><button onclick="ui.closeConfirm()" class="flex-1 py-3 rounded-xl border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 font-bold text-sm bg-transparent">ត្រឡប់ក្រោយ</button><button onclick="ui.executeDelete()" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold text-sm shadow-lg shadow-red-200 dark:shadow-none">លុបចោល</button></div>
        </div>
    </div>

    <div id="modal-import-overlay" class="hidden flex items-center justify-center">
        <div class="confirm-box dark:bg-gray-800 animate-slide-up">
            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-file-import text-xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2 font-serif-kh">បញ្ចូលទិន្ន័យ?</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4" id="import-msg-count">បានរកឃើញ ... ទិន្ន័យ</p>
            <div class="flex gap-3">
                <button onclick="document.getElementById('modal-import-overlay').classList.add('hidden')" class="flex-1 py-3 rounded-xl border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 font-bold text-sm bg-transparent">បោះបង់</button>
                <button id="btn-confirm-import" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-sm shadow-lg shadow-blue-200 dark:shadow-none">យល់ព្រម</button>
            </div>
        </div>
    </div>

    <div id="home-header-container" class="smart-header-anim">
        <header class="header-bg text-white">
            <div class="px-5 pt-3 flex justify-between items-start">
                <button onclick="ui.toggleTheme()" class="w-10 h-10 rounded-full bg-white/10 backdrop-blur border border-white/20 flex items-center justify-center active:scale-95 transition"><i id="theme-icon" class="fas fa-moon text-white"></i></button>
                
                <div id="header-home-title" class="text-center overflow-hidden w-full px-2 mt-2">
                    <h1 class="text-xl font-bold font-serif-kh tracking-wide drop-shadow-md whitespace-nowrap overflow-hidden text-ellipsis">MY SMALL SHOP TRACKER</h1>
                    <p class="text-[10px] text-teal-100 opacity-90 font-light tracking-wider mt-0.5">Professional by Norn🤣</p>
                </div>

                <button onclick="dataManager.downloadBackup()" class="w-10 h-10 rounded-full bg-white/10 backdrop-blur border border-white/20 flex items-center justify-center active:scale-95 transition"><i class="fas fa-download text-white"></i></button>
            </div>

            <div class="floating-stats-container">
                <div class="flex gap-3 justify-center w-full max-w-lg">
                    <div class="stat-card w-1/2 flex flex-col items-center"><div class="w-8 h-8 rounded-full bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center mb-1"><i class="fas fa-wallet text-teal-600 dark:text-teal-400 text-sm"></i></div><span class="text-xs text-gray-400 dark:text-gray-500 font-bold uppercase">ចំណេញជាក់ស្ដែង</span><h2 class="text-3xl font-bold text-teal-700 dark:text-teal-400 mt-1" id="dash-real-profit">$0.00</h2></div>
                    <div class="stat-card w-1/2 flex flex-col items-center"><div class="w-8 h-8 rounded-full bg-orange-100 dark:bg-orange-900/50 flex items-center justify-center mb-1"><i class="fas fa-hourglass-half text-orange-500 dark:text-orange-400 text-sm"></i></div><span class="text-xs text-gray-400 dark:text-gray-500 font-bold uppercase">ចំណេញរំពឹងទុក</span><h2 class="text-3xl font-bold text-orange-500 dark:text-orange-400 mt-1" id="dash-pending-profit">$0.00</h2></div>
                </div>
            </div>
        </header>
    </div>

    <div id="report-header-container" class="smart-header-anim">
        <div class="report-header-bg">
            <h2 class="text-lg font-bold text-teal-700 dark:text-teal-400 font-serif-kh pl-1 flex items-center gap-2 drop-shadow-sm mb-3"><i class="fas fa-chart-line"></i> របាយការណ៍</h2>
            <div class="flex items-center gap-2 mb-2">
                <div class="relative flex-1 group">
                    <i class="far fa-calendar-alt date-icon-overlay"></i>
                    <input type="text" id="date-start" class="modern-date-input" placeholder="ចាប់ពី">
                </div>
                <div class="text-gray-400"><i class="fas fa-arrow-right"></i></div>
                <div class="relative flex-1 group">
                     <i class="far fa-calendar-check date-icon-overlay"></i>
                    <input type="text" id="date-end" class="modern-date-input" placeholder="ដល់">
                </div>
            </div>
            <div class="grid grid-cols-4 gap-2">
                <button id="btn-today" onclick="ui.setReportDate('today')" class="date-filter-btn py-2 rounded-lg text-[10px] font-bold border active:scale-95 transition shadow-sm">ថ្ងៃនេះ</button>
                <button id="btn-yesterday" onclick="ui.setReportDate('yesterday')" class="date-filter-btn py-2 rounded-lg text-[10px] font-bold border active:scale-95 transition shadow-sm">ម្សិលមិញ</button>
                <button id="btn-thisWeek" onclick="ui.setReportDate('thisWeek')" class="date-filter-btn py-2 rounded-lg text-[10px] font-bold border active:scale-95 transition shadow-sm">សប្ដាហ៍នេះ</button>
                <button id="btn-thisMonth" onclick="ui.setReportDate('thisMonth')" class="date-filter-btn py-2 rounded-lg text-[10px] font-bold border active:scale-95 transition shadow-sm">ខែនេះ</button>
            </div>
        </div>
    </div>

    <main class="main-content">
        <div id="view-home" class="section-view active">
            <div class="px-1 mb-3">
                 <div class="relative bg-white dark:bg-gray-800 rounded-2xl shadow-pop border border-gray-100 dark:border-gray-700">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-teal-600"><i class="fas fa-filter text-lg"></i></div>
                    <select id="filter-dropdown" onchange="ui.filterList(this.value)" class="w-full py-3.5 pl-10 pr-10 bg-transparent text-base font-bold text-gray-700 dark:text-white outline-none appearance-none rounded-2xl">
                        <option value="all">📑 បង្ហាញទាំងអស់ (All)</option><option value="pending">⏳ រង់ចាំ (Pending)</option><option value="ordered">🛒 បានកុម្មង់ (Ordered)</option><option value="shipping">🚚 កំពុងដឹក (Shipping)</option><option value="completed">✅ ជោគជ័យ (Completed)</option><option value="cancelled">❌ បោះបង់ (Cancelled)</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-400"><i class="fas fa-chevron-down"></i></div>
                </div>
            </div>
            <div class="search-box-container px-1">
                <div class="relative shadow-pop bg-white dark:bg-gray-800 rounded-2xl">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400 text-lg"></i></div>
                    <input type="text" id="search-input" onkeyup="ui.renderHome()" class="pl-10 input-field rounded-2xl border-none h-14 text-base bg-transparent" placeholder="ស្វែងរកឈ្មោះ, លេខទូរស័ព្ទ...">
                </div>
            </div>
            <div id="order-list" class="pb-10"><div class="text-center mt-10 text-gray-400 text-sm">កំពុងផ្ទុកទិន្ន័យ...</div></div>
        </div>

        <div id="view-reports" class="section-view">
            <div id="report-content" class="animate-fade-in bg-white dark:bg-gray-900 rounded-3xl p-1 mb-6">
                
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-5 text-white mb-5 shadow-lg relative overflow-hidden">
                    <div class="absolute right-[-20px] top-[-20px] text-[100px] text-white opacity-10 pointer-events-none"><i class="fas fa-globe"></i></div>
                    <div class="relative z-10">
                        <h3 class="text-xs font-bold uppercase tracking-widest opacity-80 mb-3 border-b border-white/20 pb-2">សរុបពីមុនមក (Lifetime Overview)</h3>
                        <div class="flex justify-between items-end">
                            <div>
                                <div class="text-[10px] opacity-90 mb-1">ប្រាក់ចំណេញសរុប</div>
                                <div class="text-3xl font-bold text-white" id="lbl-lifetime-profit">$0.00</div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] opacity-90 mb-1">ចំនួនលក់សរុប</div>
                                <div class="text-xl font-bold text-white" id="lbl-lifetime-orders">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="px-2 mb-2 text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-filter"></i> ទិន្ន័យតាមកាលបរិច្ឆេទ
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="report-item card-gradient-green relative overflow-hidden">
                        <div class="absolute right-[-10px] top-[-10px] text-6xl text-emerald-500 opacity-10"><i class="fas fa-coins"></i></div>
                        <div class="text-xs text-emerald-700 dark:text-emerald-200 font-bold uppercase mb-1 z-10 relative">ចំណេញ (Net Profit)</div>
                        <div class="text-2xl font-bold text-emerald-800 dark:text-white z-10 relative" id="rpt-net-profit">$0.00</div>
                    </div>
                    <div class="report-item relative overflow-hidden bg-blue-50 dark:bg-blue-900/20 border-blue-100 dark:border-blue-800">
                        <div class="absolute right-[-10px] top-[-10px] text-6xl text-blue-500 opacity-10"><i class="fas fa-shopping-cart"></i></div>
                        <div class="text-xs text-blue-600 dark:text-blue-300 font-bold uppercase mb-1 z-10 relative">ចំនួនលក់ (Orders)</div>
                        <div class="text-2xl font-bold text-blue-800 dark:text-white z-10 relative" id="rpt-order-count">0</div>
                    </div>
                </div>

                <div class="stat-card mb-4 !p-5">
                    <h3 class="font-bold text-gray-800 dark:text-white text-sm mb-4 border-b border-gray-100 dark:border-gray-700 pb-2 flex items-center justify-between">
                        <span>ចំណូល & ចំណាយ (តាមការជ្រើសរើស)</span>
                        <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-500">Details</span>
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500 dark:text-gray-400 font-medium">ចំណូលសរុប (Sales)</span>
                            <span class="font-bold text-teal-600 dark:text-teal-400" id="rpt-total-income">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500 dark:text-gray-400 font-medium">ភ្ញៀវចេញថ្លៃដឹក</span>
                            <span class="font-bold text-gray-700 dark:text-gray-300" id="rpt-shipping-in">$0.00</span>
                        </div>
                        <hr class="border-dashed border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500 dark:text-gray-400 font-medium">ថ្លៃដើមទំនិញ (COGS)</span>
                            <span class="font-bold text-red-500" id="rpt-cogs-total">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500 dark:text-gray-400 font-medium">ចំណាយថ្លៃដឹក</span>
                            <span class="font-bold text-red-400" id="rpt-ship-exp">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500 dark:text-gray-400 font-medium">ចំណាយ Ads/Boost</span>
                            <span class="font-bold text-red-400" id="rpt-ads-total">$0.00</span>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-3 mt-2 flex justify-between items-center border border-gray-100 dark:border-gray-700">
                            <span class="text-xs font-bold text-gray-500 uppercase">Margin %</span>
                            <span class="text-sm font-bold text-blue-600 dark:text-blue-400" id="rpt-margin">0%</span>
                        </div>
                    </div>
                </div>

                <div class="stat-card mb-4 !p-0 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-800 dark:text-white text-sm">🔥 ទំនិញលក់ដាច់ (Top 5)</h3>
                        <i class="fas fa-crown text-yellow-500 text-xs"></i>
                    </div>
                    <div id="top-products-list" class="divide-y divide-gray-100 dark:divide-gray-700">
                        </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-8">
                <button onclick="ui.generatePDFStatement()" class="py-3.5 bg-red-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-red-200 dark:shadow-none hover:bg-red-700 active:scale-95 transition flex items-center justify-center gap-2 col-span-2">
                    <i class="fas fa-file-pdf"></i> Download PDF Statement (A4)
                </button>
                <button onclick="ui.exportReportCSV()" class="py-3.5 bg-green-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-green-200 dark:shadow-none hover:bg-green-700 active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
                <button onclick="ui.shareReportText()" class="py-3.5 bg-blue-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-blue-200 dark:shadow-none hover:bg-blue-700 active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fas fa-copy"></i> Copy Text
                </button>
            </div>
        </div>

        <div id="view-history" class="section-view pt-5 px-4 pb-20">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-6 pl-1 font-serif-kh">ប្រវត្តិសកម្មភាព</h2>
            <div id="activity-log"></div>
        </div>

        <div id="view-settings" class="section-view pt-5">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4 pl-1 font-serif-kh">ការកំណត់</h2>
            <div class="stat-card mb-6">
                <h3 class="font-bold text-gray-700 dark:text-gray-300 text-base mb-4 flex items-center gap-2"><i class="fas fa-database text-teal-600 dark:text-teal-400"></i> គ្រប់គ្រងទិន្ន័យ (Data Management)</h3>
                
                <div class="space-y-3 mb-4">
                    <button onclick="dataManager.downloadBackup()" class="w-full py-4 bg-teal-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-teal-200 dark:shadow-none hover:bg-teal-700 active:scale-95 transition flex items-center justify-center">
                        <i class="fas fa-download mr-2 text-lg"></i>
                        📥 ១. រក្សាទុកឯកសារ (Download JSON Backup)
                    </button>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <label class="w-full flex items-center justify-center py-4 bg-blue-50 dark:bg-gray-800 text-blue-700 dark:text-blue-400 border border-blue-100 dark:border-gray-700 rounded-xl text-sm font-bold cursor-pointer active:bg-blue-100 transition text-center hover:bg-blue-100">
                            <i class="fas fa-file-import mr-2"></i> ២. ដាក់ចូល (Import)<br><span class="text-[10px] opacity-70">(JSON or Excel/CSV)</span>
                            <input type="file" id="import-input" onchange="dataManager.prepareImport(this)" class="hidden" accept=".json, .csv">
                        </label>
                        <button onclick="dataManager.exportCSV()" class="py-4 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800 rounded-xl text-sm font-bold active:bg-green-100 hover:bg-green-100">
                            <i class="fas fa-file-excel mr-2"></i> ៣. បញ្ចេញ Excel (All)
                        </button>
                    </div>
                </div>

                <div class="p-3 bg-yellow-50 dark:bg-yellow-900/10 rounded-xl border border-yellow-100 dark:border-yellow-800 text-xs text-yellow-700 dark:text-yellow-400 mb-4">
                    <i class="fas fa-info-circle mr-1"></i> <b>ចំណាំ៖</b> មុខងារ Import ថ្មីអាចទទួលឯកសារ <b>.JSON</b> (ពី Backup) និង <b>.CSV</b> (ពី Excel) បានទាំងអស់។
                </div>
            </div>
            
            <div class="stat-card mb-8 p-0 overflow-hidden"><div class="p-5 flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition" onclick="ui.openTrashModal(true)"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 text-red-500 flex items-center justify-center"><i class="fas fa-trash-alt text-base"></i></div><span class="text-base font-bold text-gray-600 dark:text-gray-300">ធុងសំរាម (Trash Bin)</span></div><i class="fas fa-chevron-right text-gray-300"></i></div></div>
            
            <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center">
                <button onclick="dataManager.resetApp()" class="text-sm font-bold text-red-500 bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/30 px-6 py-4 rounded-xl hover:bg-red-100 transition w-full">
                    <i class="fas fa-exclamation-triangle mr-1"></i> ៤. លុបចោលទិន្ន័យទាំងអស់ (Reset)
                </button>
            </div>
        </div>
    </main>

    <div class="nav-container">
        <div class="nav-item active" onclick="ui.switchTab('home')"><i class="fas fa-home text-lg"></i><span>ទំព័រដើម</span></div>
        <div class="nav-item" onclick="ui.switchTab('reports')"><i class="fas fa-chart-pie text-lg"></i><span>ស្ថិតិ</span></div>
        <div class="fab-wrapper"><div class="fab-button" onclick="ui.openOrderModal()"><i class="fas fa-plus"></i></div></div>
        <div class="nav-item" onclick="ui.switchTab('history')"><i class="fas fa-history text-lg"></i><span>ប្រវត្តិ</span></div>
        <div class="nav-item" onclick="ui.switchTab('settings')"><i class="fas fa-cog text-lg"></i><span>កំណត់</span></div>
    </div>

    <div id="modal-order" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 w-full sm:w-[450px] h-[90vh] sm:h-auto rounded-t-3xl sm:rounded-2xl p-6 overflow-y-auto animate-slide-up pb-24 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white font-serif-kh" id="modal-title">ការលក់ថ្មី</h3>
                <div class="flex gap-2">
                    <div id="invoice-btn-group" class="hidden gap-2">
                        <button onclick="ui.openInvoice('customer')" class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center text-blue-600 dark:text-blue-400 hover:bg-blue-200 transition"><i class="fas fa-file-invoice text-lg"></i></button>
                        <button onclick="ui.openInvoice('admin')" class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center text-purple-600 dark:text-purple-400 hover:bg-purple-200 transition"><i class="fas fa-user-shield text-lg"></i></button>
                    </div>
                    <button onclick="ui.shareTextOrder()" class="w-10 h-10 rounded-full bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center text-teal-600 dark:text-teal-400 hover:bg-teal-200 transition"><i class="fas fa-share-alt text-lg"></i></button>
                    <button onclick="ui.closeModal('modal-order')" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-500 dark:text-gray-300"><i class="fas fa-times text-lg"></i></button>
                </div>
            </div>
            
            <form id="form-order" class="space-y-4" onsubmit="return false;">
                <input type="hidden" id="entry-id">
                
                <div class="p-4 rounded-2xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30">
                    <span class="label-text text-base mb-2 block font-bold text-gray-500 dark:text-gray-400"><i class="fas fa-user mr-1"></i> អតិថិជន</span>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="cust-name" placeholder="ឈ្មោះអតិថិជន" required class="col-span-2 input-field font-bold">
                        <input type="tel" id="cust-phone" placeholder="លេខទូរស័ព្ទ" class="input-field">
                        <input type="text" id="cust-addr" placeholder="ទីតាំង" class="input-field">
                    </div>
                </div>

                <div class="p-4 rounded-2xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30">
                    <span class="label-text text-base mb-2 block font-bold text-gray-500 dark:text-gray-400"><i class="fas fa-box mr-1"></i> ទំនិញ</span>
                    <div class="grid grid-cols-4 gap-3">
                        <input type="text" id="prod-name" placeholder="ឈ្មោះទំនិញ / កូដ" required class="col-span-4 input-field font-bold text-gray-700 dark:text-white text-lg">
                        <input type="text" id="prod-size" placeholder="Size" class="col-span-2 input-field text-center">
                        <input type="number" id="prod-qty" value="1" placeholder="Qty" class="col-span-2 input-field text-center">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-teal-50 dark:bg-teal-900/20 p-3 rounded-2xl border border-teal-100 dark:border-teal-800"><span class="label-text text-teal-700 dark:text-teal-400 text-sm">ចំណូល (Income)</span><input type="number" step="0.01" id="val-sale" placeholder="លក់ ($)" class="input-field font-bold text-teal-700 dark:text-teal-400 mb-2 text-lg"><input type="number" step="0.01" id="val-ship-in" placeholder="ភ្ញៀវចេញថ្លៃដឹក" class="input-field text-sm"></div>
                    <div class="bg-red-50 dark:bg-red-900/20 p-3 rounded-2xl border border-red-100 dark:border-red-800"><span class="label-text text-red-700 dark:text-red-400 text-sm">ចំណាយ (Cost)</span><input type="number" step="0.01" id="cost-buy" placeholder="ថ្លៃដើម ($)" class="input-field mb-2"><input type="number" step="0.01" id="cost-ship" placeholder="ថ្លៃដឹកចេញ" class="input-field mb-2"><input type="number" step="0.01" id="cost-boost" placeholder="Boost ($)" class="input-field"></div>
                </div>
                
                <div class="p-3 rounded-2xl border border-gray-200 dark:border-gray-700 bg-yellow-50 dark:bg-yellow-900/10">
                    <span class="label-text text-sm text-yellow-700 dark:text-yellow-500 mb-1 block"><i class="fas fa-sticky-note mr-1"></i> ចំណាំ (Note)</span>
                    <input type="text" id="note" placeholder="សរសេរចំណាំខ្លីៗ..." class="w-full bg-transparent border-none outline-none text-gray-700 dark:text-gray-300 placeholder-gray-400 font-sans">
                </div>

                <div>
                    <span class="label-text text-base mb-1 block">ស្ថានភាព</span>
                    <div class="relative">
                        <select id="status" class="w-full p-4 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-base font-bold text-gray-700 dark:text-white outline-none appearance-none">
                            <option value="pending">⏳ រង់ចាំ (Pending)</option>
                            <option value="ordered">🛒 បានកុម្មង់ (Ordered)</option>
                            <option value="shipping">🚚 កំពុងដឹក (Shipping)</option>
                            <option value="completed">✅ ជោគជ័យ (Completed)</option>
                            <option value="cancelled">❌ បោះបង់ (Cancelled)</option>
                        </select>
                        <div class="absolute right-3 top-4 pointer-events-none text-gray-500"><i class="fas fa-chevron-down"></i></div>
                    </div>
                </div>
                <div class="pt-2 flex gap-3"><button type="button" onclick="ui.saveOrder()" class="flex-1 py-4 bg-teal-600 text-white rounded-xl font-bold shadow-lg shadow-teal-200 dark:shadow-none hover:bg-teal-700 transition transform active:scale-95 text-base">រក្សាទុក</button></div>
            </form>
        </div>
    </div>

    <div id="invoice-modal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl overflow-hidden shadow-2xl animate-fade-in relative">
            <div id="invoice-viewer" class="p-6 bg-white text-black font-sans relative"></div>
            <div id="invoice-actions" class="bg-gray-100 p-4 flex justify-between gap-3 border-t border-gray-200">
                <button onclick="ui.closeModal('invoice-modal')" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-bold text-xs">បិទ</button>
                <button onclick="ui.saveInvoiceAsImage()" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-bold text-xs shadow hover:bg-blue-700"><i class="fas fa-image mr-2"></i> Save Img</button>
                <button onclick="print()" class="flex-1 px-4 py-2 rounded-lg bg-teal-600 text-white font-bold text-xs shadow-lg hover:bg-teal-700"><i class="fas fa-print mr-2"></i> Print / PDF</button>
            </div>
        </div>
    </div>

    <div id="modal-trash" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 hidden overflow-y-auto animate-slide-up">
        <div class="sticky top-0 bg-red-500 text-white shadow-md p-4 flex items-center justify-between z-10 pt-6">
            <div class="flex items-center gap-3"><button onclick="ui.closeModal('modal-trash')" class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white hover:bg-white/30"><i class="fas fa-arrow-left"></i></button><h2 class="text-xl font-bold font-serif-kh">ធុងសំរាម</h2></div>
            <button onclick="dataManager.emptyTrash()" class="text-sm font-bold px-4 py-2 bg-white text-red-500 rounded-lg shadow-sm">សម្អាតទាំងអស់</button>
        </div>
        <div id="trash-list" class="p-4 space-y-3 pb-24"></div>
    </div>

    <script>
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(reg => console.log('SW Registered!', reg.scope)).catch(err => console.log('SW Error:', err)); }); }

        window.onerror = (m) => { document.getElementById('app-loader').style.display = 'none'; console.error(m); };
        
        // --- V67: ADVANCED SMART SCROLL LOGIC ---
        // Uses "Accumulator" logic to prevent jitter and accidental triggers
        let lastScrollTop = 0; 
        let scrollUpAccumulator = 0; // Tracks intention to scroll up
        const homeHeader = document.getElementById('home-header-container');
        const reportHeader = document.getElementById('report-header-container');
        
        window.addEventListener('scroll', () => { 
            const s = window.pageYOffset || document.documentElement.scrollTop; 
            const delta = s - lastScrollTop;

            if (s <= 0) { // Top of page, always show
                homeHeader.classList.remove('hide-ui');
                reportHeader.classList.remove('hide-ui');
                return;
            }

            if (delta > 0) {
                // SCROLLING DOWN: Hide FAST
                scrollUpAccumulator = 0; // Reset up-counter
                if (s > 60) { // Threshold for hiding (quick)
                    homeHeader.classList.add('hide-ui');
                    reportHeader.classList.add('hide-ui');
                }
            } else {
                // SCROLLING UP: Show SLOW (Accumulate delta)
                scrollUpAccumulator += delta; // delta is negative here
                
                // You must scroll UP by at least 120px total to trigger the show
                // This prevents "stop/touch" jitter
                if (scrollUpAccumulator < -120) { 
                    homeHeader.classList.remove('hide-ui');
                    reportHeader.classList.remove('hide-ui');
                }
            }
            lastScrollTop = s; 
        }, { passive: true }); // Improve scroll performance

        // --- APP LOGIC (FULL CODE - NO SKIPPING) ---
        const DB_CONFIG = { name: 'ShopProV67', version: 1, store: 'orders' }; let dbConn;
        let deleteIdTarget = null;
        let fpStart, fpEnd;
        
        const db = {
            init: () => new Promise(r => { const q = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version); q.onupgradeneeded = e => { const d = e.target.result; if(!d.objectStoreNames.contains(DB_CONFIG.store)) d.createObjectStore(DB_CONFIG.store, { keyPath: 'id' }); if(!d.objectStoreNames.contains('logs')) d.createObjectStore('logs', { keyPath: 'id' }); }; q.onsuccess = e => { dbConn = e.target.result; r(); }; }),
            getAll: (s=DB_CONFIG.store) => new Promise(r => { if(!dbConn) return r([]); const q = dbConn.transaction(s, 'readonly').objectStore(s).getAll(); q.onsuccess = () => r(q.result||[]); }),
            put: (d, s=DB_CONFIG.store) => new Promise(r => { if(!dbConn) return; const q = dbConn.transaction(s, 'readwrite').objectStore(s).put(d); q.oncomplete = () => r(); }),
            delete: (id, s=DB_CONFIG.store) => new Promise(r => { if(!dbConn) return; const q = dbConn.transaction(s, 'readwrite').objectStore(s).delete(id); q.oncomplete = () => r(); }),
            clear: (s=DB_CONFIG.store) => new Promise(r => { if(!dbConn) return; const q = dbConn.transaction(s, 'readwrite').objectStore(s).clear(); q.oncomplete = () => r(); })
        };

        const app = {
            data: [], logs: [], filter: 'all',
            init: async () => { 
                await db.init(); 
                document.getElementById('app-loader').style.display = 'flex';
                await app.refresh(); 
                if(localStorage.getItem('theme') === 'dark') { document.documentElement.classList.add('dark'); document.getElementById('theme-icon').className = 'fas fa-sun text-yellow-300'; }
                history.replaceState({page: 'home'}, null, '');
                window.onpopstate = ui.handleBack;
                
                ui.initDatePickers();
                ui.setReportDate('today'); 
                
                ui.switchTab('home');

                setTimeout(() => { document.getElementById('app-loader').style.opacity = '0'; setTimeout(()=>document.getElementById('app-loader').style.display='none',500); }, 800);
            },
            refresh: async () => { 
                const all = await db.getAll(); 
                app.data = all.sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt)); 
                const logs = await db.getAll('logs');
                app.logs = logs.sort((a,b)=>b.id-a.id);
                ui.renderHome(); ui.renderStats(); ui.renderHistory(); 
            },
            calc: (o) => { const inc = (parseFloat(o.valSale)||0) + (parseFloat(o.valShipIn)||0); const exp = (parseFloat(o.costBuy)||0) + (parseFloat(o.costShip)||0) + (parseFloat(o.costBoost)||0); return { income: inc, expense: exp, profit: inc - exp, cogs: parseFloat(o.costBuy)||0, shipExp: parseFloat(o.costShip)||0, boost: parseFloat(o.costBoost)||0, sale: parseFloat(o.valSale)||0, shipIn: parseFloat(o.valShipIn)||0 }; },
            logActivity: async (msg) => { 
                const log = { id: Date.now(), msg: msg, time: new Date().toLocaleTimeString('km-KH') };
                await db.put(log, 'logs');
                app.logs.unshift(log); // Add to local array
                ui.renderHistory(); // Update UI immediately
            }
        };

        const ui = {
            showToast: (msg) => { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); },
            toggleTheme: () => { document.documentElement.classList.toggle('dark'); const isDark = document.documentElement.classList.contains('dark'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); document.getElementById('theme-icon').className = isDark ? 'fas fa-sun text-yellow-300' : 'fas fa-moon text-white'; },
            
            switchTab: (tabId) => { 
                if(tabId !== 'home') history.pushState({page: tabId}, null, '');
                
                // --- FIX NAVIGATION ACTIVE STATE ---
                // Correct mapping: Home(0), Reports(1), History(2), Settings(3)
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(el => el.classList.remove('active'));

                if(tabId === 'home') navItems[0].classList.add('active');
                if(tabId === 'reports') navItems[1].classList.add('active');
                if(tabId === 'history') navItems[2].classList.add('active'); // Index 2 is History
                if(tabId === 'settings') navItems[3].classList.add('active'); // Index 3 is Settings
                
                document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active')); 
                document.getElementById(`view-${tabId}`).classList.add('active'); 

                const homeHeader = document.getElementById('home-header-container');
                const reportHeader = document.getElementById('report-header-container');
                
                if (tabId === 'home') {
                    homeHeader.style.display = 'block';
                    reportHeader.style.display = 'none';
                    window.scrollTo(0,0);
                } else if (tabId === 'reports') {
                    homeHeader.style.display = 'none';
                    reportHeader.style.display = 'block';
                    ui.renderStats();
                    window.scrollTo(0,0);
                } else {
                    homeHeader.style.display = 'none';
                    reportHeader.style.display = 'none';
                }
            },
            
            filterList: (f) => { app.filter = f; ui.renderHome(); },
            showNote: (note) => { document.getElementById('note-content-display').innerText = note; document.getElementById('modal-note').classList.remove('hidden'); },
            
            handleBack: (event) => {
                const modals = ['modal-order', 'invoice-modal', 'modal-trash', 'modal-note', 'modal-confirm-overlay', 'modal-import-overlay'];
                let closed = false;
                for (let id of modals) { let el = document.getElementById(id); if (el && !el.classList.contains('hidden')) { if (id === 'invoice-modal') ui.closeModal('invoice-modal'); else if (id === 'modal-confirm-overlay') ui.closeConfirm(); else el.classList.add('hidden'); closed = true; break; } }
                if (closed) return;
                const activeTab = document.querySelector('.section-view.active');
                if (activeTab && activeTab.id !== 'view-home') { ui.switchTab('home'); return; }
            },

            initDatePickers: () => {
                const config = {
                    dateFormat: "Y-m-d",
                    disableMobile: true,
                    onChange: (selectedDates, dateStr, instance) => {
                         document.querySelectorAll('.date-filter-btn').forEach(b => {
                            b.className = 'date-filter-btn py-2 rounded-lg text-[10px] font-bold border border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 active:scale-95 transition shadow-sm w-full';
                        });
                        ui.renderStats();
                    }
                };
                fpStart = flatpickr("#date-start", config);
                fpEnd = flatpickr("#date-end", config);
            },

            setReportDate: (range) => {
                const now = new Date();
                let start = new Date();
                let end = new Date();
                
                document.querySelectorAll('.date-filter-btn').forEach(b => {
                    b.className = 'date-filter-btn py-2 rounded-lg text-[10px] font-bold border border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 active:scale-95 transition shadow-sm w-full';
                });

                const activeBtn = document.getElementById(`btn-${range}`);
                if(activeBtn) activeBtn.className = 'date-filter-btn py-2 rounded-lg text-[10px] font-bold active:scale-95 transition w-full date-btn-active';

                if(range === 'today') { start = now; end = now; }
                else if(range === 'yesterday') { start.setDate(now.getDate() - 1); end.setDate(now.getDate() - 1); }
                else if(range === 'thisWeek') { const day = now.getDay() || 7; if(day !== 1) start.setHours(-24 * (day - 1)); }
                else if(range === 'thisMonth') { start.setDate(1); }
                
                if(fpStart) fpStart.setDate(start);
                if(fpEnd) fpEnd.setDate(end);
                ui.renderStats();
            },

            getFilteredReportData: () => {
                const sStr = document.getElementById('date-start').value;
                const eStr = document.getElementById('date-end').value;
                if(!sStr || !eStr) return [];
                const s = new Date(sStr); const e = new Date(eStr);
                s.setHours(0,0,0,0); e.setHours(23,59,59,999);
                return app.data.filter(o => { if(o.isDeleted || o.status === 'cancelled') return false; const d = new Date(o.updatedAt); return d >= s && d <= e; });
            },

            renderStats: () => {
                // 1. LIFETIME STATS CALCULATION
                let allTimeProfit = 0;
                let allTimeOrders = 0;
                
                app.data.forEach(o => {
                    if(!o.isDeleted && o.status === 'completed') {
                        const f = app.calc(o);
                        allTimeProfit += f.profit;
                        allTimeOrders++;
                    }
                });
                
                document.getElementById('lbl-lifetime-profit').innerText = `$${allTimeProfit.toFixed(2)}`;
                document.getElementById('lbl-lifetime-orders').innerText = allTimeOrders;

                // 2. FILTERED STATS CALCULATION
                const data = ui.getFilteredReportData();
                let totalInc=0, totalCogs=0, totalShip=0, totalAds=0, netProfit=0, shippingIn=0;
                let prodMap = {};

                data.forEach(o => {
                    const f = app.calc(o);
                    totalInc += f.sale; shippingIn += f.shipIn; totalCogs += f.cogs; totalShip += f.shipExp; totalAds += f.boost; netProfit += f.profit;
                    if(!prodMap[o.prodName]) prodMap[o.prodName] = 0; prodMap[o.prodName] += parseInt(o.prodQty);
                });

                document.getElementById('rpt-order-count').innerText = data.length;
                document.getElementById('rpt-net-profit').innerText = `$${netProfit.toFixed(2)}`;
                document.getElementById('rpt-total-income').innerText = `$${totalInc.toFixed(2)}`;
                document.getElementById('rpt-shipping-in').innerText = `$${shippingIn.toFixed(2)}`;
                document.getElementById('rpt-cogs-total').innerText = `$${totalCogs.toFixed(2)}`;
                document.getElementById('rpt-ship-exp').innerText = `$${totalShip.toFixed(2)}`;
                document.getElementById('rpt-ads-total').innerText = `$${totalAds.toFixed(2)}`;
                const margin = (totalInc > 0) ? ((netProfit / (totalInc + shippingIn)) * 100) : 0;
                document.getElementById('rpt-margin').innerText = `${margin.toFixed(1)}%`;

                const sortedProds = Object.entries(prodMap).sort((a,b) => b[1] - a[1]).slice(0, 5);
                const list = document.getElementById('top-products-list');
                list.innerHTML = '';
                if(sortedProds.length === 0) list.innerHTML = '<div class="p-4 text-center text-xs text-gray-400">មិនមានទិន្ន័យ</div>';
                sortedProds.forEach(([name, qty]) => {
                    list.innerHTML += `<div class="p-3 flex justify-between items-center text-sm"><span class="text-gray-700 dark:text-gray-300 font-bold truncate pr-2">${name}</span><span class="px-2 py-1 bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400 text-xs font-bold rounded-md">${qty} Sold</span></div>`;
                });
            },

            // --- HISTORY TIMELINE RENDER FUNCTION ---
            renderHistory: () => {
                const container = document.getElementById('activity-log');
                if(!app.logs || app.logs.length === 0) {
                    container.innerHTML = '<div class="text-center mt-20 text-gray-400 italic"><i class="fas fa-history text-3xl mb-2 opacity-50"></i><p>មិនទាន់មានសកម្មភាព</p></div>';
                    return;
                }
                
                let html = '<div class="relative pl-4 space-y-6 before:absolute before:left-0 before:top-2 before:bottom-0 before:w-0.5 before:bg-gray-200 dark:before:bg-gray-700">';
                let lastDate = '';

                app.logs.slice(0, 50).forEach(log => {
                    const date = new Date(log.id);
                    const dateStr = date.toLocaleDateString('km-KH');
                    const isNewDay = dateStr !== lastDate;
                    
                    if(isNewDay) {
                         html += `<div class="relative">
                            <span class="bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 text-[10px] font-bold px-2 py-1 rounded-md border border-gray-200 dark:border-gray-700 -ml-6 relative z-10">${dateStr}</span>
                        </div>`;
                        lastDate = dateStr;
                    }

                    let icon = 'fa-circle';
                    let color = 'text-gray-400';
                    let bg = 'bg-gray-100';

                    if(log.msg.includes('បង្កើត')) { icon = 'fa-plus'; color = 'text-green-500'; bg = 'bg-green-50 dark:bg-green-900/20'; }
                    else if(log.msg.includes('លុប')) { icon = 'fa-trash'; color = 'text-red-500'; bg = 'bg-red-50 dark:bg-red-900/20'; }
                    else if(log.msg.includes('Restore')) { icon = 'fa-undo'; color = 'text-blue-500'; bg = 'bg-blue-50 dark:bg-blue-900/20'; }

                    html += `
                    <div class="relative pl-6">
                        <div class="absolute -left-[5px] top-1 w-3 h-3 rounded-full border-2 border-white dark:border-gray-900 ${color.replace('text', 'bg')} z-10"></div>
                        <div class="flex items-start justify-between bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${bg} ${color} flex items-center justify-center flex-shrink-0">
                                    <i class="fas ${icon} text-xs"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-700 dark:text-gray-200">${log.msg}</p>
                                </div>
                            </div>
                            <span class="text-[10px] text-gray-400 font-mono whitespace-nowrap ml-2">${log.time}</span>
                        </div>
                    </div>`;
                });
                
                html += '</div>';
                container.innerHTML = html;
            },

            exportReportCSV: () => {
                const data = ui.getFilteredReportData();
                if(data.length === 0) { ui.showToast("⚠️ គ្មានទិន្ន័យសម្រាប់ Export"); return; }
                let csv = "\uFEFFDate,Product,Customer,Qty,Sale,Cost,Profit\n";
                data.forEach(o => { const f = app.calc(o); csv += `${new Date(o.updatedAt).toLocaleDateString()},"${o.prodName}","${o.custName}",${o.prodQty},${f.sale},${f.expense},${f.profit}\n`; });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Report_${document.getElementById('date-start').value}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            },
            
            // --- V67: PROFESSIONAL PDF GENERATION (NATIVE PRINT) ---
            generatePDFStatement: () => {
                const data = ui.getFilteredReportData();
                if(data.length === 0) { ui.showToast("⚠️ គ្មានទិន្ន័យសម្រាប់ Download"); return; }
                
                // Fill Summary
                const start = document.getElementById('date-start').value;
                const end = document.getElementById('date-end').value;
                document.getElementById('print-date-range').innerText = `${start} to ${end}`;
                document.getElementById('print-gen-date').innerText = new Date().toLocaleString('km-KH');
                
                let tSale=0, tExp=0, tProf=0;
                const tableBody = document.getElementById('print-table-body');
                tableBody.innerHTML = '';

                data.forEach(o => {
                    const f = app.calc(o);
                    tSale += f.income;
                    tExp += f.expense;
                    tProf += f.profit;
                    
                    const row = `<tr>
                        <td class="text-left text-gray-500">${new Date(o.updatedAt).toLocaleDateString()}</td>
                        <td class="text-left font-bold text-gray-800">${o.custName}</td>
                        <td class="text-left text-gray-700">${o.prodName} <span class="text-xs text-gray-400">(${o.prodSize||'-'})</span></td>
                        <td class="text-center font-bold">${o.prodQty}</td>
                        <td class="text-right text-gray-500">$${f.expense.toFixed(2)}</td>
                        <td class="text-right text-gray-800">$${f.income.toFixed(2)}</td>
                        <td class="text-right font-bold ${f.profit>=0?'text-teal-700':'text-red-500'}">$${f.profit.toFixed(2)}</td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });

                document.getElementById('print-total-sales').innerText = `$${tSale.toFixed(2)}`;
                document.getElementById('print-total-exp').innerText = `$${tExp.toFixed(2)}`;
                document.getElementById('print-net-profit').innerText = `$${tProf.toFixed(2)}`;

                // Trigger Browser Print (User saves as PDF)
                window.print();
            },

            shareReportText: () => {
                const p = document.getElementById('rpt-net-profit').innerText; const o = document.getElementById('rpt-order-count').innerText; const s = document.getElementById('rpt-total-income').innerText; 
                const start = document.getElementById('date-start').value; 
                const end = document.getElementById('date-end').value;
                const text = `📊 របាយការណ៍សង្ខេប (${start} - ${end})\n------------------------\n💰 ចំណេញសុទ្ធ: ${p}\n📦 ចំនួនលក់: ${o}\n💵 ចំណូលសរុប: ${s}\n------------------------\nបង្កើតដោយ: My Small Shop App`;
                navigator.clipboard.writeText(text); ui.showToast("📋 បានចម្លងអក្សររបាយការណ៍!");
            },

            renderHome: () => {
                const container = document.getElementById('order-list'); const search = document.getElementById('search-input').value.toLowerCase(); container.innerHTML = '';
                let activeData = app.data.filter(o => !o.isDeleted);
                if (app.filter !== 'all') activeData = activeData.filter(o => o.status === app.filter);
                if (search) activeData = activeData.filter(o => o.custName.toLowerCase().includes(search) || o.custPhone.includes(search) || o.prodName.toLowerCase().includes(search));

                let realP = 0, pendP = 0;
                app.data.filter(o => !o.isDeleted).forEach(o => { const f = app.calc(o); if(o.status === 'completed') realP += f.profit; else if(o.status !== 'cancelled') pendP += f.profit; });
                document.getElementById('dash-real-profit').innerText = `$${realP.toFixed(2)}`; document.getElementById('dash-pending-profit').innerText = `$${pendP.toFixed(2)}`;

                if (activeData.length === 0) { container.innerHTML = `<div class="text-center mt-20 opacity-40"><i class="fas fa-box-open text-5xl mb-3 text-gray-300 dark:text-gray-600"></i><p class="text-sm text-gray-400 dark:text-gray-500">មិនមានទិន្ន័យ</p></div>`; return; }
                
                activeData.forEach(o => {
                    const f = app.calc(o); 
                    const totalPay = (parseFloat(o.valSale)||0) + (parseFloat(o.valShipIn)||0);
                    const el = document.createElement('div');
                    
                    let st = { bg: 'bg-orange-50', text: 'text-orange-600', strip: 'bg-orange-400', label: 'រង់ចាំ', icon: 'fa-clock' };
                    if(o.status === 'ordered') st = { bg: 'bg-blue-50', text: 'text-blue-600', strip: 'bg-blue-500', label: 'បានកុម្មង់', icon: 'fa-cart-shopping' };
                    if(o.status === 'shipping') st = { bg: 'bg-indigo-50', text: 'text-indigo-600', strip: 'bg-indigo-500', label: 'កំពុងដឹក', icon: 'fa-truck-fast' };
                    if(o.status === 'completed') st = { bg: 'bg-emerald-50', text: 'text-emerald-600', strip: 'bg-emerald-500', label: 'ជោគជ័យ', icon: 'fa-check-circle' };
                    if(o.status === 'cancelled') st = { bg: 'bg-red-50', text: 'text-red-600', strip: 'bg-red-500', label: 'បោះបង់', icon: 'fa-circle-xmark' };
                    
                    let paymentHtml = '';
                    if(o.status === 'completed') {
                        paymentHtml = `<span class="text-emerald-600 font-bold text-[11px] flex items-center gap-1"><i class="fas fa-check-circle"></i> ទូទាត់រួច</span>`;
                    } else if(o.status !== 'cancelled') {
                        paymentHtml = `<span class="text-orange-500 font-bold text-[11px] flex items-center gap-1"><i class="fas fa-clock"></i> រង់ចាំការទូទាត់: $${totalPay.toFixed(2)}</span>`;
                    } else {
                        paymentHtml = `<span class="text-gray-400 font-bold text-[11px]">-</span>`;
                    }

                    el.className = 'order-card p-0 group'; 
                    el.onclick = () => ui.openOrderModal(o.id);
                    
                    el.innerHTML = `
                        <div class="card-strip ${st.strip}"></div>
                        <div class="p-5 pl-6">
                            <div class="flex justify-between items-center mb-3">
                                <span class="status-badge ${st.bg} ${st.text}"><i class="fas ${st.icon}"></i> ${st.label}</span>
                                <span class="text-[11px] text-gray-400 dark:text-gray-500 font-bold font-sans tracking-wide">${new Date(o.updatedAt).toLocaleDateString('km-KH')}</span>
                            </div>
                            <div class="mb-3 pb-3 border-b border-gray-100 dark:border-gray-700/50">
                                <h4 class="font-bold text-gray-800 dark:text-white text-lg leading-tight mb-1">${o.custName}</h4>
                                <div class="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400">
                                    <span class="flex items-center gap-1"><i class="fas fa-phone-alt text-[10px] mt-[3px]"></i> ${o.custPhone || 'N/A'}</span>
                                    <span class="flex items-center gap-1 max-w-[150px] truncate"><i class="fas fa-map-marker-alt text-[10px] mt-[3px]"></i> ${o.custAddr || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-start">
                                <div class="flex-1 pr-2">
                                    <div class="font-bold text-gray-700 dark:text-gray-200 text-sm mb-1">${o.prodName}</div>
                                    <div class="flex flex-wrap gap-2">
                                        ${o.prodSize ? `<span class="px-2 py-0.5 rounded-md bg-gray-100 dark:bg-gray-700 text-[10px] font-bold text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-600">Size: ${o.prodSize}</span>` : ''}
                                        <span class="px-2 py-0.5 rounded-md bg-teal-50 dark:bg-teal-900/30 text-[10px] font-bold text-teal-700 dark:text-teal-400 border border-teal-100 dark:border-teal-800">Qty: ${o.prodQty}</span>
                                    </div>
                                </div>
                                <div class="text-right flex flex-col items-end">
                                    <div class="font-bold text-xl ${f.profit >= 0 ? 'text-teal-600 dark:text-teal-400' : 'text-red-500'} mb-1">${f.profit >= 0 ? '+' : ''}$${f.profit.toFixed(2)}</div>
                                </div>
                            </div>
                            <hr class="border-dashed border-gray-200 dark:border-gray-700/50 my-3">
                            <div class="flex justify-between items-center">
                                <div>${paymentHtml}</div>
                                <div class="flex gap-2">
                                    ${o.note ? `<button onclick="event.stopPropagation(); ui.showNote('${o.note.replace(/'/g, "\\'")}')" class="w-8 h-8 rounded-full bg-yellow-50 text-yellow-600 flex items-center justify-center hover:bg-yellow-100 transition border border-yellow-100"><i class="fas fa-sticky-note text-xs"></i></button>` : ''}
                                    <button onclick="event.stopPropagation(); ui.confirmDelete(${o.id})" class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/20 text-red-500 flex items-center justify-center hover:bg-red-100 transition border border-red-100 dark:border-red-900/30"><i class="fas fa-trash-alt text-xs"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },
            
            openOrderModal: (id = null) => {
                history.pushState({modal: true}, null, ''); 
                const modal = document.getElementById('modal-order'); modal.classList.remove('hidden');
                document.getElementById('status').value = 'pending'; document.getElementById('entry-id').value = ''; document.getElementById('modal-title').innerText = "បង្កើតការលក់ថ្មី"; document.getElementById('invoice-btn-group').classList.add('hidden'); document.getElementById('invoice-btn-group').classList.remove('flex');
                ['cust-name','cust-phone','cust-addr','prod-name','prod-size','val-sale','val-ship-in','cost-buy','cost-ship','cost-boost','note'].forEach(i => document.getElementById(i).value = '');
                document.getElementById('prod-qty').value = '1';

                if(id) {
                    const o = app.data.find(x => x.id === id); 
                    if(o) {
                        document.getElementById('modal-title').innerText = "កែប្រែទិន្ន័យ"; document.getElementById('entry-id').value = o.id;
                        document.getElementById('cust-name').value = o.custName; document.getElementById('cust-phone').value = o.custPhone; document.getElementById('cust-addr').value = o.custAddr;
                        document.getElementById('prod-name').value = o.prodName; document.getElementById('prod-size').value = o.prodSize; document.getElementById('prod-qty').value = o.prodQty;
                        document.getElementById('val-sale').value = o.valSale; document.getElementById('val-ship-in').value = o.valShipIn;
                        document.getElementById('cost-buy').value = o.costBuy; document.getElementById('cost-ship').value = o.costShip; document.getElementById('cost-boost').value = o.costBoost;
                        document.getElementById('note').value = o.note || '';
                        document.getElementById('status').value = o.status; document.getElementById('invoice-btn-group').classList.remove('hidden'); document.getElementById('invoice-btn-group').classList.add('flex');
                    }
                }
            },
            closeModal: (id) => document.getElementById(id).classList.add('hidden'),
            
            saveOrder: async () => {
                try {
                    const idStr = document.getElementById('entry-id').value; const custName = document.getElementById('cust-name').value; const prodName = document.getElementById('prod-name').value;
                    if(!custName || !prodName) { alert("សូមបញ្ចូលឈ្មោះអតិថិជន និងឈ្មោះទំនិញ!"); return; }

                    const payload = {
                        id: idStr ? parseInt(idStr) : Date.now(),
                        updatedAt: new Date().toISOString(),
                        custName: custName, custPhone: document.getElementById('cust-phone').value, custAddr: document.getElementById('cust-addr').value,
                        prodName: prodName, prodSize: document.getElementById('prod-size').value, prodQty: document.getElementById('prod-qty').value,
                        valSale: document.getElementById('val-sale').value, valShipIn: document.getElementById('val-ship-in').value,
                        costBuy: document.getElementById('cost-buy').value, costShip: document.getElementById('cost-ship').value, costBoost: document.getElementById('cost-boost').value,
                        note: document.getElementById('note').value,
                        status: document.getElementById('status').value, isDeleted: false
                    };
                    
                    const existingIdx = app.data.findIndex(x => x.id === payload.id);
                    if(existingIdx > -1) { app.data[existingIdx] = payload; } else { app.data.unshift(payload); }
                    app.data.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    
                    ui.renderHome(); ui.renderStats(); ui.closeModal('modal-order'); ui.showToast('✅ រក្សាទុកជោគជ័យ');
                    await db.put(payload); if(!idStr) await app.logActivity(`បានបង្កើត: ${payload.prodName}`);

                } catch(e) { alert("Error: " + e); }
            },

            confirmDelete: (id) => { history.pushState({modal: true}, null, ''); deleteIdTarget = id; document.getElementById('modal-confirm-overlay').classList.remove('hidden'); },
            closeConfirm: () => { deleteIdTarget = null; document.getElementById('modal-confirm-overlay').classList.add('hidden'); },
            executeDelete: async () => {
                if(!deleteIdTarget) return;
                const id = deleteIdTarget;
                const item = app.data.find(x => x.id === id);
                if(item) {
                    item.isDeleted = true;
                    ui.renderHome(); ui.closeConfirm(); ui.showToast('🗑️ បានលុប');
                    await db.put(item); await app.logActivity(`បានលុប: ${item.prodName}`); ui.closeModal('modal-order');
                }
            },

            openTrashModal: async (fetchFromDB = false) => {
                history.pushState({modal: true}, null, ''); 
                if(fetchFromDB) await app.refresh(); 
                const modal = document.getElementById('modal-trash');
                modal.classList.remove('hidden');
                ui.renderTrashList();
            },
            
            renderTrashList: () => {
                const list = document.getElementById('trash-list');
                list.innerHTML = '';
                const deleted = app.data.filter(o => o.isDeleted);
                if(deleted.length === 0) list.innerHTML = '<div class="text-center mt-20 text-gray-400"><i class="fas fa-trash-alt text-4xl mb-2"></i><p>ធុងសំរាមស្អាត</p></div>';
                
                deleted.forEach(o => {
                    const d = document.createElement('div');
                    d.className = 'bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-4 rounded-xl flex justify-between items-center';
                    d.innerHTML = `<div><h4 class="font-bold text-gray-700 dark:text-gray-200 text-lg mb-1">${o.prodName}</h4><p class="text-sm text-gray-500 font-sans">${new Date(o.updatedAt).toLocaleDateString()}</p></div><button onclick="ui.restore(${o.id})" class="px-4 py-2 bg-teal-100 text-teal-800 text-sm font-bold rounded-lg hover:bg-teal-200 transition"><i class="fas fa-undo mr-1"></i> Restore</button>`;
                    list.appendChild(d);
                });
            },

            restore: async (id) => {
                const item = app.data.find(x => x.id === id);
                if(item) { item.isDeleted = false; ui.renderTrashList(); ui.renderHome(); ui.renderStats(); ui.showToast('♻️ បានយកមកវិញ'); await db.put(item); await app.logActivity(`បាន Restore: ${item.prodName}`); }
            },
            
            openInvoice: (type) => {
                history.pushState({modal: true}, null, ''); 
                const id = parseInt(document.getElementById('entry-id').value);
                const o = app.data.find(x => x.id === id); if(!o) return;
                const f = app.calc(o); const viewer = document.getElementById('invoice-viewer');
                
                let html = `<div id="invoice-capture" class="bg-white p-6 relative overflow-hidden" style="font-family: 'Battambang', sans-serif;"><div class="absolute top-0 left-0 w-full h-2 bg-teal-600"></div><div class="text-center mb-6 border-b-2 border-teal-500 pb-4"><h2 class="text-2xl font-bold text-teal-700">វិក្កយបត្រ</h2><p class="text-[10px] text-gray-500 uppercase tracking-widest mt-1">INVOICE #${o.id.toString().slice(-6)}</p><p class="text-[10px] text-gray-400 mt-0.5">${new Date().toLocaleString('km-KH')}</p></div><div class="flex justify-between text-[11px] mb-6"><div class="text-left"><span class="text-teal-600 font-bold block text-[9px] uppercase mb-1">Bill To:</span><span class="font-bold text-gray-800 text-sm block mb-0.5">${o.custName}</span><div class="text-gray-500">${o.custPhone}</div><div class="text-gray-500">${o.custAddr}</div></div><div class="text-right"><span class="text-teal-600 font-bold block text-[9px] uppercase mb-1">From:</span><span class="font-bold text-gray-800 text-sm block mb-0.5">MY SMALL SHOP</span><div class="text-gray-500">Phnom Penh, Cambodia</div></div></div><div class="mb-6"><div class="flex justify-between bg-teal-50 p-2 rounded-t-lg border-b-2 border-teal-100"><span class="text-[10px] font-bold text-teal-700 uppercase">បរិយាយ (Description)</span><span class="text-[10px] font-bold text-teal-700 uppercase">តម្លៃ (Price)</span></div><div class="flex justify-between items-center p-3 border-b border-gray-100"><div><div class="text-sm font-bold text-gray-800">${o.prodName}</div><div class="text-[10px] text-gray-500 mt-0.5">Size: ${o.prodSize || '-'} | Qty: ${o.prodQty}</div></div><div class="text-sm font-bold text-gray-800">$${f.sale.toFixed(2)}</div></div></div><div class="flex justify-end mb-6"><div class="w-1/2 space-y-1 text-right"><div class="flex justify-between text-[11px] text-gray-500"><span>សរុបរង:</span><span>$${f.sale.toFixed(2)}</span></div><div class="flex justify-between text-[11px] text-gray-500"><span>ថ្លៃដឹក:</span><span>$${f.shipIn.toFixed(2)}</span></div><div class="flex justify-between text-base font-bold text-teal-700 mt-2 pt-2 border-t border-teal-100 bg-teal-50 p-2 rounded"><span>សរុបរួម:</span><span>$${f.income.toFixed(2)}</span></div></div></div>${type === 'admin' ? `<div class="mt-4 pt-2 border-t-2 border-red-100 bg-red-50 p-2 rounded border-dashed"><h4 class="text-center text-[9px] font-bold text-red-400 uppercase tracking-widest mb-1">INTERNAL USE ONLY</h4><div class="grid grid-cols-2 gap-1 text-[9px] text-gray-600"><div>ថ្លៃដើម: <b>$${f.cogs.toFixed(2)}</b></div><div>ថ្លៃដឹកចេញ: <b>$${f.shipExp.toFixed(2)}</b></div><div>Ads: <b>$${f.boost.toFixed(2)}</b></div><div>សរុប: <b class="text-red-500">$${f.expense.toFixed(2)}</b></div></div><div class="mt-2 text-center border-t border-red-200 pt-1"><span class="text-[9px] font-bold text-gray-500">ប្រាក់ចំណេញ</span><div class="text-sm font-bold ${f.profit>=0?'text-green-600':'text-red-600'}">$${f.profit.toFixed(2)}</div></div></div>` : `<div class="text-center mt-auto pt-6 border-t border-gray-100"><p class="text-[10px] text-teal-600 font-bold mb-1">Thank you for your business!</p><p class="text-[10px] text-gray-400 font-serif-kh">អរគុណដែលបានគាំទ្រអាជីវកម្មពួកយើង!</p></div>`}</div>`;
                viewer.innerHTML = html; document.getElementById('invoice-modal').classList.remove('hidden');
            },
            saveInvoiceAsImage: () => { 
                const element = document.getElementById('invoice-capture'); 
                html2canvas(element, { 
                    scale: 3, 
                    useCORS: true, 
                    allowTaint: true, 
                    backgroundColor: "#ffffff", 
                    onclone: (clonedDoc) => { 
                        const el = clonedDoc.getElementById('invoice-capture');
                        el.style.fontFamily = "'Battambang', sans-serif";
                        el.style.letterSpacing = 'normal'; 
                    } 
                }).then(canvas => { 
                    const link = document.createElement('a'); 
                    link.download = `Invoice_${new Date().toISOString().slice(0,10)}.png`; 
                    link.href = canvas.toDataURL("image/png", 1.0); 
                    link.click(); 
                    ui.showToast("✅ រក្សាទុកជារូបភាព!"); 
                }); 
            },
            shareTextOrder: async () => { const cName = document.getElementById('cust-name').value; const cPhone = document.getElementById('cust-phone').value; const cAddr = document.getElementById('cust-addr').value; const pName = document.getElementById('prod-name').value; const pSize = document.getElementById('prod-size').value; const pQty = document.getElementById('prod-qty').value; const vSale = parseFloat(document.getElementById('val-sale').value) || 0; const vShip = parseFloat(document.getElementById('val-ship-in').value) || 0; const total = vSale + vShip; const text = `📦 វិក្កយបត្រ / ORDER DETAIL\n------------------------\n👤 អតិថិជន: ${cName}\n📞 ទូរស័ព្ទ: ${cPhone}\n📍 ទីតាំង: ${cAddr}\n------------------------\n🛍️ ទំនិញ: ${pName} ${pSize ? '('+pSize+')' : ''}\n🔢 ចំនួន: ${pQty}\n------------------------\n💰 តម្លៃទំនិញ: $${vSale.toFixed(2)}\n🚚 ថ្លៃដឹក: $${vShip.toFixed(2)}\n💵 សរុប: $${total.toFixed(2)}\n------------------------\nអរគុណ! Thank you! 🙏`; if (navigator.share) { try { await navigator.share({ title: 'Order Details', text: text }); } catch(e) {} } else { navigator.clipboard.writeText(text); ui.showToast("📋 បានចម្លងអក្សរវិក្កយបត្រ!"); } },
            
            dataManager: {
                downloadBackup: () => {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app.data));
                    const dlAnchorElem = document.createElement('a');
                    dlAnchorElem.setAttribute("href", dataStr);
                    dlAnchorElem.setAttribute("download", `shop_backup_${new Date().toISOString().slice(0,10)}.json`);
                    document.body.appendChild(dlAnchorElem);
                    dlAnchorElem.click();
                    dlAnchorElem.remove();
                    ui.showToast("✅ បាន Download ឯកសារ Backup!");
                },

                prepareImport: (input) => {
                    const file = input.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const content = e.target.result;
                            let importedData = [];
                            if (file.name.toLowerCase().endsWith('.json')) importedData = JSON.parse(content);
                            else if (file.name.toLowerCase().endsWith('.csv')) importedData = dataManager.parseCSV(content);
                            else throw new Error("Format not supported");

                            if (!Array.isArray(importedData) || importedData.length === 0) throw new Error("No data found");

                            ui.showImportConfirm(importedData.length, importedData);
                            input.value = '';
                        } catch (err) { alert("Error: " + err.message); }
                    };
                    reader.readAsText(file);
                },

                executeImport: async (data) => {
                    document.getElementById('modal-import-overlay').classList.add('hidden');
                    const loader = document.getElementById('app-loader');
                    loader.style.display = 'flex';
                    document.getElementById('loader-text').innerText = "កំពុងបញ្ចូលទិន្ន័យ...";

                    try {
                        const tx = dbConn.transaction(DB_CONFIG.store, 'readwrite');
                        const store = tx.objectStore(DB_CONFIG.store);
                        data.forEach(item => store.put(item));

                        tx.oncomplete = async () => {
                            await app.refresh();
                            loader.style.display = 'none';
                            ui.showToast(`✅ បញ្ចូល ${data.length} ទិន្ន័យជោគជ័យ!`);
                        };
                        
                        tx.onerror = (e) => { throw new Error(e.target.error); };
                    } catch (err) {
                        loader.style.display = 'none';
                        alert("Import Failed: " + err);
                    }
                },

                parseCSV: (text) => {
                    const lines = text.split('\n').filter(l => l.trim() !== '');
                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                        if (!values) continue;
                        const cleanVal = (val) => val ? val.replace(/^"|"$/g, '').replace(/""/g, '"').trim() : '';
                        
                        let parsedDate = new Date().toISOString(); 
                        if (values[15]) {
                             const rawD = cleanVal(values[15]);
                             if(rawD && rawD.length > 5) parsedDate = rawD;
                        } else if (values[0]) {
                            const dateStr = cleanVal(values[0]);
                            const d = new Date(dateStr);
                            if (!isNaN(d.getTime())) {
                                parsedDate = d.toISOString();
                            }
                        }

                        const row = {
                            id: Date.now() + Math.random(),
                            updatedAt: parsedDate, 
                            custName: cleanVal(values[1]),
                            custPhone: cleanVal(values[2]),
                            custAddr: cleanVal(values[3]),
                            prodName: cleanVal(values[4]),
                            prodSize: cleanVal(values[5]),
                            prodQty: cleanVal(values[6]) || 1,
                            costBuy: values[12] ? cleanVal(values[12]) : (cleanVal(values[7]) || 0),
                            valSale: values[13] ? cleanVal(values[13]) : (cleanVal(values[8]) || 0),
                            valShipIn: values[14] ? cleanVal(values[14]) : 0,
                            costShip: 0, costBoost: 0,
                            status: cleanVal(values[10]) || 'pending',
                            note: cleanVal(values[11]) || '',
                            isDeleted: false
                        };
                        data.push(row);
                    }
                    return data;
                },

                exportCSV: () => {
                    const items = app.data;
                    let csvContent = "\uFEFFDate,Customer,Phone,Address,Product,Size,Qty,Cost (Total),Income (Total),Profit,Status,Note,RawCost,RawSale,RawShipIn,RawDate\n";
                    items.forEach(o => {
                        const f = app.calc(o);
                        const q = (s) => `"${(s||'').toString().replace(/"/g, '""')}"`;
                        const row = [
                            new Date(o.updatedAt).toLocaleDateString(), 
                            q(o.custName), q(o.custPhone), q(o.custAddr), q(o.prodName),
                            o.prodSize, o.prodQty,
                            f.expense.toFixed(2), f.income.toFixed(2), f.profit.toFixed(2),
                            o.status,
                            q(o.note),
                            o.costBuy || 0, o.valSale || 0, o.valShipIn || 0,
                            o.updatedAt
                        ].join(",");
                        csvContent += row + "\n";
                    });
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `Shop_Report_${new Date().toISOString().slice(0,10)}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                resetApp: async () => {
                    if (confirm("⚠️ តើអ្នកពិតជាចង់លុបចោលទិន្ន័យទាំងអស់មែនទេ? (មិនអាចយកវិញបានទេ)")) {
                        await db.clear(); await db.clear('logs'); localStorage.clear(); location.reload();
                    }
                }
            }
        };
        
        ui.showImportConfirm = (count, data) => {
            document.getElementById('import-msg-count').innerText = `បានរកឃើញ ${count} ទិន្ន័យ`;
            const modal = document.getElementById('modal-import-overlay');
            const btn = document.getElementById('btn-confirm-import');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = () => dataManager.executeImport(data);
            modal.classList.remove('hidden');
        };

        const dataManager = ui.dataManager;
        window.onload = app.init;
    </script>
</body>
</html>